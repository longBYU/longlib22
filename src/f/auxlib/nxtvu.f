C
C
	SUBROUTINE NXTVU(IC,D,N,W,NN,IER)
	SAVE
C
C	ROUTINE TO PLOT VISIBLE LINES LINES FOR USE WITH PLT3D
C	LINES BEHIND A PLANAR SURFACE STORED IN W ARE NOT PLOTTED
C	MODIFIED 8/11/87 BY D.LONG, JPL
C
C	IC	(I)	INTIALIZE/DIRECTION CODE
C			 > 0 PLOT SURFACE ABOVE W
C			 < 0 PLOT SURFACE BELOW W
C			 = +1 FIRST CALL FOR ABOVE SURFACE
C			 = +2 FOR SUBSEQUENT CALLS ABOVE SURFACE
C			 = -1 FIRST CALL FOR BELOW SURFACE
C			 NOTE THAT VISIBLE EDGE IS NOT PLOTTED
C			 FOR BELOW PLOT OPTION
C			 = -2 FOR SUBSEQUENT CALLS BELOW SURFACE
C	D	(R)	INPUT POINT PAIRS
C			 D(1) = X(1)
C			 D(2) = Y(1)
C			  ...
C	N	(I)	NUMBER OF POINT PAIRS IN D ARRAY
C	W	(R)	ARRAY STORING TOP (BOTOM) HIDDEN PLANE
C			 (SHOULD NOT BE MODIFIED BETWEEN CALLS)
C	NN	(I)	DIMENSION OF W
C	IER	(I)	RETURNED ERROR FLAG
C			 = 0, OK
C		 	 = 1 OUT OF SPACE ERROR IN W
C
	DIMENSION D(1),W(1)
C
	IX(I)=(I-1)*2+1
	IY(I)=2*I
C
C	DETERMINE DIRECTION AND INITIALIZE
C
	DI=1.0
	IF (IC.LT.0) DI=-1.0
	IF (IABS(IC).NE.1.AND.IC.NE.0) GOTO 20
C
C	CHECK OVERFLOW BUFFER
C
	IF (N.GT.NN/2) GOTO 500
	LL=NN/2-N+1
	I=LL
	W(IX(I))=D(IX(1))
	W(IY(I))=DI*D(IY(1))
	IF (IC.GT.0) CALL PLOT(D(IX(1)),D(IY(1)),3)
	DO 10 J=2,N
		I=I+1
		W(IX(I))=D(IX(J))
		W(IY(I))=DI*D(IY(J))
		IF (IC.GT.0) CALL PLOT(D(IX(J)),D(IY(J)),2)
10	CONTINUE
	IER=0
	RETURN
20	IF (IER.NE.0) RETURN
	II=1
	JJ=LL
	KK=0
	YA0=DI*D(IY(1))
	YB0=W(IY(LL))
	IF (D(IX(1))-W(IX(LL))) 30,30,70
30	CALL PLOT(D(IX(1)),DI*YA0,3)
40	CALL NXT0VU(D(IX(II)),DI*D(IY(II)),W,KK,LL,IER)
	IF (II.EQ.N) GOTO 360
	II=II+1
	YA0=DI*D(IY(II))
	IF (D(IX(II)).GT.W(IX(LL))) GOTO 50
	CALL PLOT(D(IX(II)),DI*YA0,2)
	GOTO 40
50	II=II-1
	XL=D(IX(II))
	YL=DI*D(IY(II))
	YA0=ANXTVU(D(IX(II)),D(IX(II+1)),DI*D(IY(II)),
     1    DI*D(IY(II+1)),W(IX(LL)))
	X0=W(IX(LL))
	IF (YA0.GT.YB0) GOTO 90
	CALL PLOT(X0,DI*YA0,2)
	CALL NXT0VU(X0,YA0,W,KK,LL,IER)
	CALL NXT0VU(X0,YB0,W,KK,LL,IER)
	GOTO 100
70	CALL NXT0VU(W(IX(JJ)),W(IY(JJ)),W,KK,LL,IER)
	IF (JJ.EQ.NN/2) GOTO 380
	JJ=JJ+1
	YB0=W(IY(JJ))
	IF (D(IX(1))-W(IX(JJ))) 80,70,70
80	JJ=JJ-1
	YB0=ANXTVU(W(IX(JJ)),W(IX(JJ+1)),W(IY(JJ)),
     1    W(IY(JJ+1)),D(IX(1)))
	X0=D(IX(1))
	IF (YA0.LE.YB0) GOTO 100
	CALL NXT0VU(X0,YB0,W,KK,LL,IER)
	CALL NXT0VU(X0,YA0,W,KK,LL,IER)
	XL=X0
	YL=YA0
90	IOV0=1
	GOTO 120
100	IOV0=0
120	IF (II.EQ.N) GOTO 300
	IF (JJ.EQ.NN/2) GOTO 310
	IF (D(IX(II+1)).GT.W(IX(JJ+1))) GOTO 130
	ISW=+1
	II=II+1
	X1=D(IX(II))
	YA1=DI*D(IY(II))
	YB1=ANXTVU(W(IX(JJ)),W(IX(JJ+1)),W(IY(JJ)),
     1     W(IY(JJ+1)),X1)
	GOTO 140
130	IF (W(IX(JJ+1)).GT.D(IX(N))) GOTO 340
	ISW=-1
	JJ=JJ+1
	X1=W(IX(JJ))
	YA1=ANXTVU(D(IX(II)),D(IX(II+1)),DI*D(IY(II)),
     1     DI*D(IY(II+1)),X1)
	YB1=W(IY(JJ))
140	IF (YA1.LE.YB1) GOTO 160
	IOV1=1
	IF (IOV0.EQ.0) GOTO 170
150	IF (ISW.EQ.-1) GOTO 200
	CALL NXT0VU(X1,YA1,W,KK,LL,IER)
	CALL PLOT(XL,DI*YL,3)
	CALL PLOT(X1,DI*YA1,2)
	XL=X1
	YL=YA1
	GOTO 200
160	IOV1=0
	IF (IOV0.EQ.0) GOTO 190
170	CONTINUE
	IF (YA1-YB1+YB0-YA0.EQ.0.0) THEN
		FRAC=1.0
	ELSE
		FRAC=(YB0-YA0)/(YA1-YB1+YB0-YA0)
	ENDIF
	XI=(X1-X0)*FRAC+X0
	YI=(YA1-YA0)*FRAC+YA0
	CALL NXT0VU(XI,YI,W,KK,LL,IER)
	IF (IOV0.EQ.0) GOTO 180
	CALL PLOT(XL,DI*YL,3)
	CALL PLOT(XI,DI*YI,2)
	XL=XI
	YL=YI
	GOTO 190
180	XL=XI
	YL=YI
	GOTO 150
190	IF (ISW.EQ.+1) GOTO 200
	CALL NXT0VU(W(IX(JJ)),W(IY(JJ)),W,KK,LL,IER)
200	IF (IER.NE.0) RETURN
	X0=X1
	YA0=YA1
	YB0=YB1
	IOV0=IOV1
	GOTO 120
310	X1=W(IX(NN/2))
	YA1=ANXTVU(D(IX(II)),D(IX(II+1)),DI*D(IY(II)),
     1     DI*D(IY(II+1)),X1)
	YB1=W(IY(NN/2))
	IF (YA1.GT.YB1) GOTO 320
	CALL NXT0VU(X1,YB1,W,KK,LL,IER)
	CALL NXT0VU(X1,YA1,W,KK,LL,IER)
	CALL PLOT(X1,DI*YA1,3)
	GOTO 330
380	II=1
320	CALL PLOT(D(IX(II)),D(IY(II)),3)
330	IF (II.EQ.N) GOTO 400
	II=II+1
	CALL NXT0VU(D(IX(II)),DI*D(IY(II)),W,KK,LL,IER)
	CALL PLOT(D(IX(II)),D(IY(II)),2)
	GOTO 330
300	IF (JJ.EQ.NN/2) GOTO 400
340	X1=D(IX(N))
	YA1=DI*D(IY(N))
	YB1=ANXTVU(W(IX(JJ)),W(IX(JJ+1)),W(IY(JJ)),
     1     W(IY(JJ+1)),X1)
	IF (YA1.LE.YB1) GOTO 350
	CALL NXT0VU(X1,YA1,W,KK,LL,IER)
	CALL NXT0VU(X1,YB1,W,KK,LL,IER)
	CALL PLOT(X1,DI*YA1,2)
350	IF (JJ.EQ.NN/2) GOTO 400
	JJ=JJ+1
	CALL NXT0VU(W(IX(JJ)),W(IY(JJ)),W,KK,LL,IER)
	GOTO 350
360	JJ=0
	GOTO 350
400	LL=NN/2-KK+1
	I=LL
	DO 410 J=1,KK
		W(IX(I))=W(IX(J))
		W(IY(I))=W(IY(J))
		I=I+1
410	CONTINUE
	RETURN
500	IER=1
	RETURN
	END
